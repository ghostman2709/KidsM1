<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <title>Hiperfoco Acesso e Ofertas</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background: linear-gradient(135deg, #001122, #002244);
      color: #66ccff;
      line-height: 1.6;
      scroll-behavior: smooth;
    }

    header {
      padding: 2rem 1rem 1rem;
      text-align: center;
    }

    header h1 {
      font-size: 2.5rem;
      color: #66ccff;
      margin: 0;
      text-shadow: 0 0 12px #3399ffcc;
      font-weight: 700;
    }

    header p {
      font-size: 1.2rem;
      color: #99ccff;
      margin-top: 0.5rem;
      text-shadow: 0 0 8px #3399ff99;
      font-weight: 600;
    }

    .section {
      padding: 2rem 1.5rem 3rem;
      max-width: 800px;
      margin: 1rem auto;
      border: 2px solid #66ccff;
      border-radius: 16px;
      background: rgba(0, 17, 34, 0.6);
      box-shadow: 0 0 30px #66ccff, 0 0 60px #3399ffaa;
    }

    .section h2 {
      color: #66ccff;
      font-size: 1.8rem;
      margin-bottom: 1rem;
      text-shadow: 0 0 5px #3399ff;
      font-weight: 700;
    }

    .link {
      display: block;
      background: rgba(102, 204, 255, 0.1);
      color: #66ccff;
      padding: 14px 20px;
      margin: 15px auto;
      text-decoration: none;
      border: 2px solid #66ccff;
      border-radius: 12px;
      transition: all 0.3s ease;
      font-weight: 700;
      font-size: 18px;
      max-width: 300px;
      backdrop-filter: blur(5px);
      cursor: pointer;
      box-shadow: 0 0 10px #66ccff;
      text-align: center;
    }

    .link:hover {
      background: #66ccff;
      color: #001122;
      transform: scale(1.05);
      box-shadow: 0 0 20px #66ccffcc;
    }

    .pix-section {
      margin-top: 3rem;
      padding: 2rem;
      background: rgba(102, 204, 255, 0.12);
      border-radius: 16px;
      box-shadow: 0 0 20px #66ccff88, 0 0 50px #3399ff55;
    }

    .pix-section h2 {
      font-size: 1.6rem;
      color: #66ccff;
      text-shadow: 0 0 10px #3399ff;
      font-weight: 700;
    }

    .pix-section p {
      color: #99ccff;
      font-size: 1rem;
      font-weight: 500;
    }

    .pix-qr {
      width: 150px;
      height: 150px;
      border-radius: 12px;
      box-shadow: 0 0 15px #66ccff;
      display: block;
      margin: 20px auto;
    }

    .pix-key {
      font-weight: bold;
      color: #aaccee;
      margin-top: 15px;
      font-size: 14px;
      word-break: break-word;
      user-select: all;
      cursor: text;
      text-align: center;
    }

    .btn-verde {
      background-color: #39ff14;
      color: #001100;
      padding: 14px 30px;
      font-weight: 700;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      font-size: 18px;
      box-shadow: 0 0 12px #39ff14, 0 0 25px #39ff14aa;
      text-decoration: none;
      transition: background-color 0.3s ease;
      margin-top: 20px;
      display: inline-block;
      text-align: center;
    }

    .btn-verde:hover {
      background-color: #2ecc00;
      color: #fff;
      box-shadow: 0 0 20px #2ecc00;
    }

    #msgCopiadoEbook, #msgCopiadoCombo {
      display: none;
      color: #00ff88;
      font-weight: 700;
      margin-top: 15px;
      text-align: center;
    }

    #audioControl {
      margin: 2rem auto;
      background: rgba(102, 204, 255, 0.1);
      border: 2px solid #66ccff;
      color: #66ccff;
      padding: 0.8rem 1.5rem;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
      display: block;
      max-width: 300px;
      text-align: center;
      user-select: none;
    }

    #audioControl:hover {
      background: #66ccff;
      color: #001122;
      transform: scale(1.05);
    }

    footer {
      text-align: center;
      padding: 2rem 1rem;
      font-size: 0.9rem;
      color: #88aabb;
      text-shadow: 0 0 5px #3399ff88;
    }

    .fade-in {
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 1.2s ease-out, transform 1.2s ease-out;
    }

    .fade-in.appear {
      opacity: 1;
      transform: translateY(0);
    }

    /* Estilos para o novo formul√°rio de upload */
    .payment-form-section {
        border-top: 2px solid #007bff;
        padding-top: 20px;
        margin-top: 20px;
    }
    .payment-form-section .field {
        margin-bottom: 15px;
    }
    .payment-form-section label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #99ccff;
    }
    .payment-form-section input[type="text"],
    .payment-form-section input[type="file"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #007bff;
        border-radius: 4px;
        background-color: rgba(0, 0, 0, 0.3);
        color: #fff;
        box-sizing: border-box;
    }
    .payment-form-section button {
        background-color: #007bff;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        width: 100%;
        margin-top: 10px;
    }
    .payment-form-section button:hover {
        background-color: #0056b3;
    }
    .message {
        margin-top: 15px;
        padding: 10px;
        border-radius: 4px;
        text-align: center;
    }
    .message.error {
        background-color: #f8d7da;
        color: #721c24;
    }
    .message.success {
        background-color: #d4edda;
        color: #155724;
    }
    .hidden {
        display: none;
    }
    #loadingSpinner {
        display: none;
        border: 4px solid rgba(0, 0, 0, .1);
        border-left-color: #007bff;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    /* Estilos para ocultar se√ß√µes quando n√£o for a p√°gina de pagamento */
    .hide-on-payment-page {
        display: block; /* Default visibility */
    }
    .payment-page-only {
        display: none; /* Hidden by default */
    }
  </style>
</head>
<body>

<header class="fade-in">
  <h1>Hiperfoco</h1>
  <p>O Poder de 10 Minutos por Dia</p>
</header>

<div class="section fade-in">
  <div id="generalContent" class="hide-on-payment-page">
      <h2 class="fade-in">üìò Cap√≠tulos Gratuitos</h2>
      <a class="link fade-in" href="https://ghostman2709.github.io/Capitulo-1/" target="_blank" rel="noopener noreferrer">Cap√≠tulo 1</a>
      <a class="link fade-in" href="https://ghostman2709.github.io/Capitulo-2/" target="_blank" rel="noopener noreferrer">Cap√≠tulo 2</a>
      <a class="link fade-in" href="https://ghostman2709.github.io/Capitulo-3/" target="_blank" rel="noopener noreferrer">Cap√≠tulo 3</a>
      <a class="link fade-in" href="https://ghostman2709.github.io/Capitulo-4/" target="_blank" rel="noopener noreferrer">Cap√≠tulo 4</a>
      <a class="link fade-in" href="https://ghostman2709.github.io/Capitulo-5/" target="_blank" rel="noopener noreferrer">Cap√≠tulo 5</a>

      <h2 class="fade-in">üéß Trilha Sonora de Foco</h2>
      <button id="audioControl" class="fade-in">Ativar Trilha Sonora üéß</button>
      <audio id="bgAudio" src="audio.mp3" loop></audio>
  </div>


  <div class="pix-section fade-in" id="pixEbook">
    <h2>
        {% if is_payment_page %}
            Confirma√ß√£o de Pagamento
        {% else %}
            üìó Ebook Completo R$19,99
        {% endif %}
    </h2>
    <p>
        {% if is_payment_page %}
            Para o produto: <strong>{{ produto_nome }}</strong> (Valor: <strong>{{ valor_esperado }}</strong>)
        {% else %}
            Pagamento via Pix para liberar cap√≠tulos 6 a 20.
        {% endif %}
    </p>
    
    <img class="pix-qr" src="{% if is_payment_page %}data:image/png;base64,{{ qrcode_b64 }}{% else %}qrcode-pix-erico.png{% endif %}" alt="QR Code para pagamento Pix" />
    
    <button onclick="copiarPix('pixPayloadEbook', 'btnEnviarComprovanteEbook', 'msgCopiadoEbook')" class="link fade-in" type="button">üìã Copiar chave Pix</button>
    <p class="pix-key" id="pixPayloadEbook">
        {% if is_payment_page %}
            {{ pix_code }}
        {% else %}
            00020126580014BR.GOV.BCB.PIX013692a349bf-d612-46fd-ab30-6532a7397b0a520400005303986540519.995802BR5924Erico Mendieta Rodriguez6009SAO PAULO62140510Uitd1vwYnc63049A7C
        {% endif %}
    </p>
    <p id="msgCopiadoEbook">‚úÖ Pix copiado!</p>
    
    <div class="payment-form-section hidden" id="formEbookPayment">
        <hr>
        <h3>Confirme seu Pagamento</h3>
        <p>Preencha os dados abaixo para validar seu comprovante.</p>
        <input type="hidden" id="currentPedidoIdEbook" value="{{ pedido_id if is_payment_page else '' }}">
        <input type="hidden" id="expectedValueEbook" value="{{ valor_esperado if is_payment_page else 'R$ 19,99' }}">

        <div class="field">
            <label for="idTransacaoPartialEbook">4 ou 5 d√≠gitos iniciais do ID da Transa√ß√£o PIX:</label>
            <input type="text" id="idTransacaoPartialEbook" placeholder="Ex: e6070" maxlength="5">
        </div>
        
        <button id="btnConfirmarIdEbook" onclick="showUploadSection('formEbookPayment')">Confirmar ID</button>
        
        <div id="uploadSectionEbook" class="hidden">
            <p style="margin-top: 10px;">Agora, fa√ßa o upload da *IMAGEM* do comprovante de pagamento:</p>
            <div class="field">
                <label for="comprovanteFileEbook">Comprovante de Pagamento:</label>
                <input type="file" id="comprovanteFileEbook" accept="image/*">
            </div>
            <button id="btnEnviarComprovanteEbook" onclick="sendComprovante('Ebook')">Enviar Comprovante</button>
        </div>
        <div id="loadingSpinnerEbook" class="hidden"></div>
        <div id="messageEbook" class="message hidden"></div>
    </div>
  </div>

  <div class="pix-section fade-in {% if is_payment_page and default_pix_section_id == 'pixEbook' %}hidden{% endif %}" id="pixCombo">
    <h2>
        {% if is_payment_page %}
            Confirma√ß√£o de Pagamento
        {% else %}
            üî• Combo Plus ‚Äì R$24,99
        {% endif %}
    </h2>
    <p>
        {% if is_payment_page %}
            Para o produto: <strong>{{ produto_nome }}</strong> (Valor: <strong>{{ valor_esperado }}</strong>)
        {% else %}
            Inclui Ebook completo + Grupo VIP com mais de 200 audiobooks e PDFs.
        {% endif %}
    </p>
    
    <img class="pix-qr" src="{% if is_payment_page %}data:image/png;base64,{{ qrcode_b64 }}{% else %}qrcode-pix-comboplus.png{% endif %}" alt="QR Code para pagamento Pix" />
    
    <button onclick="copiarPix('pixPayloadCombo', 'btnEnviarComprovanteCombo', 'msgCopiadoCombo')" class="link fade-in" type="button">üìã Copiar chave Pix</button>
    <p class="pix-key" id="pixPayloadCombo">
        {% if is_payment_page %}
            {{ pix_code }}
        {% else %}
            00020126580014BR.GOV.BCB.PIX013692a349bf-d612-46fd-ab30-6532a7397b0a520400005303986540524.995802BR5924Erico Mendieta Rodriguez6009SAO PAULO62140510wZYGFi1iA26304125D
        {% endif %}
    </p>
    <p id="msgCopiadoCombo">‚úÖ Pix copiado!</p>
    
    <div class="payment-form-section hidden" id="formComboPayment">
        <hr>
        <h3>Confirme seu Pagamento</h3>
        <p>Preencha os dados abaixo para validar seu comprovante.</p>
        <input type="hidden" id="currentPedidoIdCombo" value="{{ pedido_id if is_payment_page else '' }}">
        <input type="hidden" id="expectedValueCombo" value="{{ valor_esperado if is_payment_page else 'R$ 24,99' }}">

        <div class="field">
            <label for="idTransacaoPartialCombo">4 ou 5 d√≠gitos iniciais do ID da Transa√ß√£o PIX:</label>
            <input type="text" id="idTransacaoPartialCombo" placeholder="Ex: f1a2b" maxlength="5">
        </div>
        
        <button id="btnConfirmarIdCombo" onclick="showUploadSection('formComboPayment')">Confirmar ID</button>
        
        <div id="uploadSectionCombo" class="hidden">
            <p style="margin-top: 10px;">Agora, fa√ßa o upload da *IMAGEM* do comprovante de pagamento:</p>
            <div class="field">
                <label for="comprovanteFileCombo">Comprovante de Pagamento:</label>
                <input type="file" id="comprovanteFileCombo" accept="image/*">
            </div>
            <button id="btnEnviarComprovanteCombo" onclick="sendComprovante('Combo')">Enviar Comprovante</button>
        </div>
        <div id="loadingSpinnerCombo" class="hidden"></div>
        <div id="messageCombo" class="message hidden"></div>
    </div>
  </div>
</div>

<footer class="fade-in">
  ¬© 2025 Projeto Hiperfoco. Todos os direitos reservados.
</footer>

<script>
  // Vari√°veis globais para o contexto de pagamento (preenchidas por Jinja2)
  const isPaymentPage = {{ 'true' if is_payment_page else 'false' }};
  const currentPedidoId = "{{ pedido_id if is_payment_page else '' }}";
  const currentProdutoNome = "{{ produto_nome if is_payment_page else '' }}";
  const currentValorEsperadoStr = "{{ valor_esperado if is_payment_page else '' }}"; // "R$ 19,99"
  const currentPixCode = "{{ pix_code if is_payment_page else '' }}";
  // Extrai o valor num√©rico de "R$ XX,YY" para o OCR
  const currentValorEsperadoNum = currentValorEsperadoStr ? parseFloat(currentValorEsperadoStr.replace('R$', '').replace(',', '.').trim()) : null;

  const ocrServiceUrl = "/confirmar_pagamento_web"; // Endpoint no seu Flask

  // Controle da trilha sonora
  const btnAudio = document.getElementById('audioControl');
  const audio = document.getElementById('bgAudio');
  let isPlaying = false;

  if(btnAudio) { // Verifica se o bot√£o existe antes de adicionar listener
      btnAudio.addEventListener('click', () => {
        if (!isPlaying) {
          audio.play();
          btnAudio.textContent = 'Parar Trilha Sonora ‚è∏Ô∏è';
          isPlaying = true;
        } else {
          audio.pause();
          btnAudio.textContent = 'Ativar Trilha Sonora üéß';
          isPlaying = false;
        }
      });
  }

  // Fun√ß√£o para copiar Pix
  function copiarPix(idPayload, idBtn, idMsg) {
    const payload = document.getElementById(idPayload).innerText.trim();
    navigator.clipboard.writeText(payload).then(() => {
      document.getElementById(idMsg).style.display = "block";
      
      // Se n√£o for uma p√°gina de pagamento espec√≠fica (como vindo do bot),
      // o bot√£o ainda levaria ao WhatsApp. Agora, mostra o formul√°rio de upload.
      if (!isPaymentPage) {
          const sectionId = idPayload.includes('Ebook') ? 'formEbookPayment' : 'formComboPayment';
          document.getElementById(sectionId).classList.remove('hidden');
          document.getElementById(idBtn).style.display = "none"; // Esconde o link antigo do WhatsApp
          document.getElementById(idBtn).previousElementSibling.style.display = "none"; // Esconde o bot√£o "Copiar chave Pix" original
          document.getElementById(sectionId).scrollIntoView({ behavior: "smooth", block: "center" });
      } else {
          // Se √© a p√°gina de pagamento, o QR e o PIX code j√° foram copiados.
          // O formul√°rio de upload j√° est√° vis√≠vel ou ser√° vis√≠vel
          alert("C√≥digo PIX copiado para a √°rea de transfer√™ncia!");
      }

    }).catch(() => {
      alert("Erro ao copiar a chave Pix.");
    });
  }

  // Fun√ß√µes para o fluxo de pagamento web
  function showUploadSection(formId) {
    const sectionPrefix = formId.includes('Ebook') ? 'Ebook' : 'Combo';
    const idTransacaoPartial = document.getElementById(`idTransacaoPartial${sectionPrefix}`).value.trim();

    if (idTransacaoPartial.length < 4 || idTransacaoPartial.length > 5) {
        showMessage(sectionPrefix, 'error', 'Por favor, digite 4 ou 5 d√≠gitos iniciais do ID da transa√ß√£o.', false);
        return;
    }
    
    // Oculta o bot√£o "Confirmar ID"
    document.getElementById(`btnConfirmarId${sectionPrefix}`).classList.add('hidden');
    // Mostra a se√ß√£o de upload
    document.getElementById(`uploadSection${sectionPrefix}`).classList.remove('hidden');
    showMessage(sectionPrefix, '', '', false); // Limpa mensagens anteriores
  }

  async function sendComprovante(sectionPrefix) {
    const idTransacaoPartial = document.getElementById(`idTransacaoPartial${sectionPrefix}`).value.trim();
    const comprovanteFile = document.getElementById(`comprovanteFile${sectionPrefix}`).files[0];
    const pedidoIdToUse = isPaymentPage ? currentPedidoId : document.getElementById(`currentPedidoId${sectionPrefix}`).value;
    const expectedValueToUseStr = isPaymentPage ? currentValorEsperadoStr : document.getElementById(`expectedValue${sectionPrefix}`).value;
    const expectedValueToUseNum = parseFloat(expectedValueToUseStr.replace('R$', '').replace(',', '.').trim());


    if (!idTransacaoPartial || !comprovanteFile) {
        showMessage(sectionPrefix, 'error', 'Por favor, preencha todos os campos e selecione um comprovante.', false);
        return;
    }

    if (idTransacaoPartial.length < 4 || idTransacaoPartial.length > 5) {
        showMessage(sectionPrefix, 'error', 'O ID da transa√ß√£o deve ter 4 ou 5 d√≠gitos.', false);
        return;
    }
    
    if (!pedidoIdToUse && !isPaymentPage) { // Se n√£o for a p√°gina de pagamento e o pedidoId n√£o foi preenchido dinamicamente
        showMessage(sectionPrefix, 'error', 'Erro: ID do pedido n√£o dispon√≠vel. Recarregue a p√°gina ou entre em contato com o suporte.', false);
        return;
    }

    showMessage(sectionPrefix, 'success', 'Enviando comprovante, aguarde...', true);
    showLoadingSpinner(sectionPrefix, true);
    
    const reader = new FileReader();
    reader.onloadend = async () => {
        const base64Image = reader.result.split(',')[1];

        try {
            const response = await fetch(ocrServiceUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    pedido_id: pedidoIdToUse, // Usa o ID do pedido correto
                    id_transacao_parcial: idTransacaoPartial,
                    imagem_b64: base64Image
                }),
            });

            const result = await response.json();
            showLoadingSpinner(sectionPrefix, false);

            if (response.ok && result.success) {
                showMessage(sectionPrefix, 'success', result.message || 'Pagamento confirmado com sucesso!', true);
                if (result.redirect_url) {
                    setTimeout(() => {
                        window.location.href = result.redirect_url;
                    }, 2000);
                }
            } else {
                showMessage(sectionPrefix, 'error', result.message || 'Falha ao confirmar pagamento. Tente novamente.', false);
            }
        } catch (error) {
            console.error('Erro ao enviar comprovante:', error);
            showLoadingSpinner(sectionPrefix, false);
            showMessage(sectionPrefix, 'error', 'Erro de comunica√ß√£o com o servidor. Tente novamente.', false);
        }
    };
    reader.readAsDataURL(comprovanteFile);
  }

  function showMessage(sectionPrefix, type, text, autoHide) {
    const messageElement = document.getElementById(`message${sectionPrefix}`);
    messageElement.classList.remove('success', 'error', 'hidden');
    messageElement.textContent = text;
    if (type) {
        messageElement.classList.add(type);
    }
    if (autoHide) {
        setTimeout(() => {
            messageElement.classList.add('hidden');
        }, 5000);
    }
  }

  func
